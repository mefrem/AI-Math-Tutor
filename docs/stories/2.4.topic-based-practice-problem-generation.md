# Story 2.4: Topic-Based Practice Problem Generation

**Status:** Done

**Epic:** Epic 2: Problem Input & Visual Rendering

---

## Story

**As a** student,
**I want** to request practice problems on specific topics (like "fractions" or "algebra"),
**so that** I can strengthen my skills without needing to bring my own homework.

---

## Acceptance Criteria

1. Topic selection interface provided when student selects "I need practice with..." pathway
2. Text input field with prompt: "What topic would you like to practice? (e.g., fractions, addition, word problems)"
3. Optional: Suggestion chips for common topics (Fractions, Algebra, Geometry, Word Problems)
4. "Generate Practice Problem" button triggers problem generation
5. Next.js API route (`/api/generate-problem`) calls GPT-4 with prompt:
   - "Generate a grade 3-8 appropriate math problem for practicing [TOPIC]. Return only the problem statement, no solution."
6. Generated problem displayed to student for confirmation
7. Student can regenerate if they want a different problem
8. Once confirmed, problem proceeds to tutoring workspace
9. Loading state during generation ("Creating a practice problem for you...")

---

## Tasks / Subtasks

- [x] Create practice problem component (AC: 1, 2, 3)
  - [x] Create `src/components/problem-input/PracticeProblemInput.tsx` component
  - [x] Add text input field with prompt: "What topic would you like to practice? (e.g., fractions, addition, word problems)"
  - [x] Add optional suggestion chips for common topics (Fractions, Algebra, Geometry, Word Problems)
  - [x] Add "Generate Practice Problem" button
  - [x] Style with Tailwind CSS following design vision
  - [x] Add proper accessibility attributes
  - [x] Ensure responsive layout works on tablet and laptop
- [x] Implement topic input and validation (AC: 2, 3)
  - [x] Add topic text input field
  - [x] Add suggestion chips for common topics (clickable)
  - [x] Handle topic selection from chips (populate input field)
  - [x] Validate topic input (not empty/whitespace)
  - [x] Display error message for empty topic
  - [x] Clear error when user starts typing or selects chip
- [x] Create generate-problem API route (AC: 5)
  - [x] Create `src/app/api/generate-problem/route.ts` API route
  - [x] Accept POST request with topic (and optional difficulty)
  - [x] Validate request body (topic required)
  - [x] Call GPT-4 with generation prompt
  - [x] Use prompt: "Generate a grade 3-8 appropriate math problem for practicing [TOPIC]. Return only the problem statement, no solution."
  - [x] Return generated problem as MathProblem object
  - [x] Handle API errors and return appropriate error responses
  - [x] Use standard error handler (`handleApiError`)
- [x] Create generate-problem API service (AC: 4, 5)
  - [x] Create `src/services/api/generateProblemApi.ts` client-side service
  - [x] Function to call `/api/generate-problem` endpoint
  - [x] Accept topic string (and optional difficulty)
  - [x] Return MathProblem or error
  - [x] Handle network errors and API errors
- [x] Add problem generation to LLM service (AC: 5)
  - [x] Update `src/services/llmService.ts` to support problem generation
  - [x] Add method `generatePracticeProblem(topic: string, difficulty?: string): Promise<MathProblem>`
  - [x] Use GPT-4 model (same as chat)
  - [x] Use generation prompt for creating practice problems
  - [x] Parse response and create MathProblem object
  - [x] Handle generation API errors
- [x] Implement problem generation flow (AC: 4, 6, 9)
  - [x] Add "Generate Practice Problem" button (enabled when topic is entered)
  - [x] Call generate-problem API when button is clicked
  - [x] Display loading state during generation ("Creating a practice problem for you...")
  - [x] Display generated problem in textarea or display area
  - [x] Show confirmation prompt: "Is this the problem you want to practice?"
  - [x] Handle generation errors gracefully
- [x] Implement generated problem confirmation (AC: 6, 7, 8)
  - [x] Display generated problem clearly
  - [x] Add "Yes, start practicing" button (approves and proceeds)
  - [x] Add "Generate another problem" button (regenerates problem)
  - [x] Handle approval: create MathProblem and navigate to workspace
  - [x] Handle regenerate: call API again with same topic
  - [x] Show loading state during regeneration
- [x] Create MathProblem from generated problem (AC: 8)
  - [x] Create MathProblem object with:
    - [x] `problemId`: Generate UUID or timestamp-based ID
    - [x] `source: 'generated'`
    - [x] `rawContent`: Generated problem text
    - [x] `parsedContent`: Same as rawContent (no parsing yet)
    - [x] `topic`: Topic used for generation
    - [x] `difficulty`: Optional difficulty level (if provided)
  - [x] Store problem in Zustand store
  - [x] Navigate to workspace after approval
- [x] Update problem input page (AC: 1, 2, 3, 4, 6, 7, 8, 9)
  - [x] Update `src/app/problem-input/page.tsx` to detect practice mode
  - [x] Check URL search params for `mode=practice`
  - [x] Show PracticeProblemInput component when in practice mode
  - [x] Show text/image input when not in practice mode
  - [x] Handle problem generation flow
  - [x] Handle generated problem confirmation
  - [x] Integrate error handling
  - [x] Ensure responsive layout works on tablet and laptop
  - [x] Follow design vision: clean, uncluttered, age-appropriate
- [x] Add generation prompt to prompts file (AC: 5)
  - [x] Add `PRACTICE_PROBLEM_GENERATION_PROMPT_V1` to `src/services/prompts.ts`
  - [x] Prompt: "Generate a grade 3-8 appropriate math problem for practicing [TOPIC]. Return only the problem statement, no solution."
  - [x] Export prompt for use in LLM service
  - [x] Follow prompt versioning pattern
- [x] Error handling (AC: 4, 5, 6, 7, 8)
  - [x] Handle empty topic input (show error message)
  - [x] Handle API failures (network errors, rate limits, invalid responses)
  - [x] Handle generation failures (show error, allow retry)
  - [x] Display user-friendly error messages (not technical errors)
  - [x] Provide recovery options (retry, manual entry)
- [x] Loading states and UX (AC: 9)
  - [x] Show loading spinner during problem generation
  - [x] Show "Creating a practice problem for you..." message
  - [x] Disable buttons during processing
  - [x] Show loading state during regeneration
  - [x] Smooth transitions between states
- [x] Style and responsive design (AC: 1, 2, 3)
  - [x] Apply consistent color palette (primary blue, secondary green, neutral grays)
  - [x] Style suggestion chips with hover and active states
  - [x] Ensure buttons are large enough for touch targets (44px minimum)
  - [x] Add hover and focus states for interactive elements
  - [x] Ensure proper spacing and typography
  - [x] Test responsive layout on tablet (768px) and laptop (1280px+)

---

## Dev Notes

### Previous Story Insights

**Source:** [Source: Story 2.2 Dev Agent Record, Story 2.3 Dev Agent Record]

From Story 2.2 completion:

- Text input component created (`src/components/problem-input/TextProblemInput.tsx`)
- Problem input page supports text input mode
- MathProblem interface created in `src/types/models.ts`
- Zustand store updated with `currentProblem` state
- Navigation flow: Landing → Problem Input → Workspace

From Story 2.3 completion:

- Image upload component created (`src/components/problem-input/ImageProblemInput.tsx`)
- Problem input page supports image input mode with toggle
- Parse-image API route created (`/api/parse-image`)
- GPT-4 Vision integration added to LLM service
- Problem input page handles both text and image modes

**Key Context for Story 2.4:**

- Landing page navigates to `/problem-input?mode=practice` when "I need practice with..." is clicked
- Problem input page currently doesn't handle practice mode (only text/image modes)
- Need to add practice mode detection and PracticeProblemInput component
- Generate-problem API route needs to be created
- Generated problems follow same flow as text/image problems (approval → workspace)
- This story adds the practice problem pathway from Epic 2

### Design Vision Requirements

**Source:** [Source: docs/prd.md#user-interface-design-goals]

**Overall UX Vision:**

- Interface should feel like "sitting next to a patient tutor at a shared desk"
- Design prioritizes simplicity, focus, and collaboration over feature-rich complexity
- Experience should be calm and uncluttered—no overwhelming toolbars or competing visual elements
- Color palette: warm and approachable (soft blues, greens, neutrals) rather than stark or corporate
- Typography: large and readable for target age group (8-14 years)

**Practice Problem Screen:**

- Topic input should be prominent and inviting
- Suggestion chips should be clearly visible and clickable
- Generated problem should be clearly displayed
- Buttons should be large and clear
- Error messages should be friendly and helpful (not technical)
- Loading states should be clear but not overwhelming

### Component Structure

**Source:** [Source: architecture/frontend-architecture.md#component-organization]

**Component Organization:**

```
src/components/
├── problem-input/         # Problem entry
│   ├── LandingPage.tsx   # Landing page (Story 2.1)
│   ├── TextProblemInput.tsx # Text input (Story 2.2)
│   ├── ImageProblemInput.tsx # Image upload (Story 2.3)
│   └── PracticeProblemInput.tsx # Practice problem (Story 2.4)
```

**Component Pattern:**

- Create presentational component in `src/components/problem-input/`
- Component should be a client component (`'use client'`) since it has form inputs and buttons
- Use TypeScript with explicit props interface
- Follow Container/Presentational separation pattern
- Handle topic state locally, call parent callback on submission

### File Locations

**Source:** [Source: architecture/unified-project-structure.md]

**Files to Create:**

- `src/components/problem-input/PracticeProblemInput.tsx` - Practice problem component
- `src/app/api/generate-problem/route.ts` - Generate problem API route
- `src/services/api/generateProblemApi.ts` - Generate problem API service (client-side)

**Files to Modify:**

- `src/app/problem-input/page.tsx` - Add practice mode detection and PracticeProblemInput component
- `src/services/llmService.ts` - Add problem generation method
- `src/services/prompts.ts` - Add practice problem generation prompt
- `src/types/api.ts` - Add GenerateProblemRequest and GenerateProblemResponse types (if not exists)

**Routing Structure:**

```
src/app/
├── api/
│   ├── chat/
│   │   └── route.ts       # Chat API (Story 1.3)
│   ├── parse-image/
│   │   └── route.ts       # Parse image API (Story 2.3)
│   └── generate-problem/
│       └── route.ts       # Generate problem API (Story 2.4)
├── problem-input/
│   └── page.tsx          # Problem input page (Story 2.2, 2.3, 2.4)
└── workspace/
    └── page.tsx          # Tutoring workspace (Story 2.7)
```

### Data Models

**Source:** [Source: architecture/data-models.md#mathproblem]

**MathProblem Interface:**

```typescript
interface MathProblem {
  problemId: string;
  source: "text" | "image" | "generated";
  rawContent: string;
  parsedContent: string;
  topic?: string;
  imageUrl?: string;
  difficulty?: "easy" | "medium" | "hard";
}
```

**For Story 2.4 (Practice Problem):**

- `problemId`: Generate UUID or timestamp-based ID
- `source`: Set to `'generated'`
- `rawContent`: Generated problem text from GPT-4
- `parsedContent`: Same as `rawContent` (no parsing yet)
- `topic`: Topic used for generation (e.g., "fractions", "algebra")
- `imageUrl`: Not needed for generated problems
- `difficulty`: Optional difficulty level (if provided in future)

**Note:** This story does NOT require LaTeX conversion. The generated problem is plain text. Rendering will be handled in Story 2.6 (KaTeX Mathematical Rendering).

### API Specification

**Source:** [Source: architecture/api-specification.md#generate-problem]

**Generate Problem API:**

- **Endpoint:** `POST /api/generate-problem`
- **Request Body:**
  ```typescript
  {
    topic: string; // Subject area for practice (e.g., "fractions")
    difficulty?: 'easy' | 'medium' | 'hard'; // Optional difficulty level
  }
  ```
- **Response:**
  ```typescript
  {
    problem: MathProblem; // Generated problem object
  }
  ```
- **Error Response:**
  ```typescript
  {
    error: {
      code: string;
      message: string;
      timestamp: string;
      requestId: string;
    }
  }
  ```

### External APIs

**Source:** [Source: architecture/external-apis.md#openai-api]

**OpenAI GPT-4 API:**

- **Endpoint:** `POST https://api.openai.com/v1/chat/completions`
- **Model:** `gpt-4-turbo` (same as chat, not Vision model)
- **Authentication:** Bearer token (API key from `OPENAI_API_KEY`)
- **Prompt:** "Generate a grade 3-8 appropriate math problem for practicing [TOPIC]. Return only the problem statement, no solution."
- **Rate Limits:** Tier 1+ recommended (3,500 requests/minute, 10,000 requests/day)
- **Cost:** ~$0.01-0.02 per problem (within PRD budget)

### State Management

**Source:** [Source: architecture/frontend-architecture.md#state-management-architecture]

**Zustand Store Pattern:**

- Current store (`useTutoringStore`) has:
  - `sessionId: string | null`
  - `messages: ConversationMessage[]`
  - `isLoading: boolean`
  - `selectedProblem: MathProblem | null` (from Story 1.6)
  - `currentProblem: MathProblem | null` (from Story 2.2)

**For Story 2.4:**

- Reuse `currentProblem` state for generated problems
- Store problem when "Yes, start practicing" is clicked
- Reset problem when session is reset
- No new store actions needed (reuse `setCurrentProblem` from Story 2.2)

**Component State:**

- Topic input state (local component state)
- Selected topic from chips (local component state)
- Generated problem state (local component state)
- Loading state (local component state)
- Error state (local component state)
- Confirmation state (local component state)

### Topic Selection Requirements

**Source:** [Source: docs/prd.md#acceptance-criteria]

**Common Topics (Suggestion Chips):**

- Fractions
- Algebra
- Geometry
- Word Problems
- Addition (optional)
- Subtraction (optional)
- Multiplication (optional)
- Division (optional)

**Topic Input:**

- Free-text input for custom topics
- Suggestion chips populate input field when clicked
- Both custom and chip topics are valid
- Validation: not empty/whitespace

**Topic Examples:**

- "fractions"
- "algebra"
- "word problems"
- "multiplication"
- "solving equations"
- Custom topics are allowed

### Problem Generation Flow

**Source:** [Source: docs/prd.md#acceptance-criteria]

**Generation Flow:**

1. User enters or selects topic
2. User clicks "Generate Practice Problem"
3. Loading state shown ("Creating a practice problem for you...")
4. API call to `/api/generate-problem` with topic
5. GPT-4 generates problem text
6. Generated problem displayed in textarea or display area
7. Confirmation prompt: "Is this the problem you want to practice?"
8. User can approve, regenerate, or return to topic selection

**Error Handling:**

- If generation fails: Show error, allow retry or manual entry
- If API fails: Show error, allow retry
- If topic is invalid: Show validation error

### GPT-4 Problem Generation

**Source:** [Source: architecture/external-apis.md#openai-api]

**GPT-4 API Call:**

```typescript
const response = await openai.chat.completions.create({
  model: "gpt-4-turbo",
  messages: [
    {
      role: "system",
      content: "You are a math problem generator for grades 3-8.",
    },
    {
      role: "user",
      content:
        "Generate a grade 3-8 appropriate math problem for practicing fractions. Return only the problem statement, no solution.",
    },
  ],
  temperature: 0.8, // Higher for variety
  max_tokens: 200,
});
```

**Prompt Strategy:**

- Use clear, specific prompt for problem generation
- Request grade-appropriate problems (3-8)
- Request only problem statement (no solution)
- Request plain text output (not LaTeX)
- Handle various topic inputs flexibly

### Error Handling

**Source:** [Source: docs/prd.md#acceptance-criteria]

**Error Scenarios:**

1. **Empty topic:** Show error "Please enter or select a topic"
2. **API failure:** Show error "Failed to generate problem. Please try again."
3. **Generation returns empty:** Show error "Could not generate problem. Please try a different topic."
4. **Network error:** Show error "Connection error. Please check your internet and try again."

**Error Recovery:**

- Provide "Try again" button
- Provide "Enter manually" option (switch to text input)
- Allow topic modification and retry
- Clear error state when valid topic is entered

### Loading States

**Source:** [Source: docs/prd.md#acceptance-criteria]

**Loading States:**

1. **Problem generation:** Show "Creating a practice problem for you..." message with spinner
2. **Problem regeneration:** Show loading state during regeneration
3. **Disable buttons:** Prevent multiple submissions during processing
4. **Smooth transitions:** Use CSS transitions for state changes

### Suggestion Chips Design

**Source:** [Source: docs/prd.md#acceptance-criteria]

**Chip Design:**

- Large, clickable chips for common topics
- Visual feedback on hover and click
- Selected chip should be visually distinct
- Chips populate topic input field when clicked
- Accessible via keyboard navigation

**Common Topics:**

- Fractions
- Algebra
- Geometry
- Word Problems
- (Optional: Addition, Subtraction, Multiplication, Division)

### Styling Requirements

**Source:** [Source: architecture/coding-standards.md#styling-with-tailwind]

**Tailwind CSS Patterns:**

- Use utility-first approach with Tailwind classes
- Apply responsive design with mobile-first classes (`md:`, `lg:`)
- Use color palette from design vision:
  - Primary: `bg-blue-500` or custom color `#4A90E2`
  - Secondary: `bg-green-500` or custom color `#7CB342`
  - Neutral: `bg-gray-100`, `text-gray-900`
  - Error: `bg-red-100`, `text-red-700`
- Ensure proper spacing with Tailwind spacing scale
- Use Tailwind typography utilities for readable text

**Suggestion Chips Styling:**

- Large, clickable chips with border
- Visual feedback on hover (border color change)
- Active/selected state (different background color)
- Grid layout for chips
- Proper spacing between chips

### Responsive Design Requirements

**Source:** [Source: docs/prd.md#target-device-and-platforms]

**Target Devices:**

- **Primary:** Laptops (1280px+ width) - MacBook, Chromebook, Windows laptop
- **Secondary:** Tablets in landscape (768px-1024px width) - iPad, Android tablets
- **Out of scope:** Mobile phones (too small for effective interaction)

**Responsive Layout:**

- Use Tailwind responsive classes: `md:` for tablet (768px+), `lg:` for laptop (1024px+)
- Ensure layout works at minimum 768px width
- Test on both tablet and laptop screen sizes
- Topic input should be full-width on tablet, centered with max-width on laptop
- Suggestion chips should wrap on smaller screens

### Accessibility Requirements

**Source:** [Source: docs/prd.md#accessibility]

**Target Level: WCAG AA Compliance (Partial for MVP)**

**Priority Requirements:**

- **Keyboard navigation:** All interactive elements (input, chips, buttons) accessible via keyboard
- **Color contrast:** Minimum 4.5:1 contrast ratio for text and important UI elements
- **Focus indicators:** Clear visual focus states for keyboard users
- **Touch targets:** Minimum 44px for tablet touch interaction
- **Form labels:** Proper label association with topic input

**Out of scope for MVP:**

- Screen reader optimization (aria labels, semantic HTML—address in post-MVP)
- Full WCAG AA compliance audit

### Technical Constraints

**Source:** [Source: architecture/tech-stack.md]

**Technology Stack:**

- **Framework:** Next.js 14+ App Router (TypeScript)
- **Styling:** Tailwind CSS 3.4+
- **State Management:** Zustand 4.5+ (existing store)
- **API Integration:** OpenAI Node.js SDK
- **Navigation:** Next.js `useRouter` or `Link` component
- **URL Search Params:** Next.js `useSearchParams` hook

**TypeScript Requirements:**

- Strict mode enabled
- Explicit prop interfaces for components
- No `any` types without explicit comments
- Proper typing for topic strings and MathProblem interface

### Testing Requirements

**Source:** [Source: docs/prd.md#testing-requirements]

**Testing Standards for this Story:**

- **Test Approach:** Manual validation through visual inspection and interaction testing
- **Test Scenarios:**
  1. Topic selection works with text input
  2. Topic selection works with suggestion chips
  3. Problem generation works for various topics
  4. Generated problem displays correctly
  5. Regeneration works correctly
  6. Confirmation flow works
  7. Error handling works for all scenarios

**Specific Test Cases:**

- **Test 1:** Topic input - verify text input accepts topic
- **Test 2:** Suggestion chips - verify chips populate input and are clickable
- **Test 3:** Problem generation - verify generates problem for "fractions" topic
- **Test 4:** Problem generation - verify generates problem for "algebra" topic
- **Test 5:** Regeneration - verify generates different problem for same topic
- **Test 6:** Confirmation - verify approval creates MathProblem and navigates
- **Test 7:** Error handling - verify API failures show user-friendly errors
- **Test 8:** Responsive - verify layout works on tablet and laptop

**Success Criteria:**

- Topic selection works correctly (text input and chips)
- Problem generation works for various topics
- Generated problem displays correctly
- Regeneration works correctly
- Confirmation flow works
- Error handling provides recovery options
- UI follows design vision

### Project Structure Notes

No conflicts identified between PRD requirements and architecture structure. The PRD specifies practice problem generation, and the architecture supports API routes, GPT-4 integration, and problem generation workflows.

**Note on Implementation:**

- This story implements the practice problem pathway from Epic 2
- Problem generation uses GPT-4 (same as chat, not Vision)
- Generated problems follow same flow as text/image problems (approval → workspace)
- This story adds problem generation capabilities to the problem input workflow

---

## Testing

**Source:** [Source: docs/prd.md#testing-requirements]

**Testing Standards for this Story:**

- **Test File Location:** Manual testing with visual inspection
- **Test Approach:** Manual validation through browser testing and interaction
- **Test Framework:** N/A (manual testing only)

**Specific Testing Requirements:**

1. **Topic Selection Test:**

   - Enter topic in text input - verify accepts input
   - Click suggestion chip (e.g., "Fractions") - verify populates input field
   - Click multiple chips - verify updates input field
   - Verify topic input is properly labeled for accessibility
   - Verify topic input has proper focus states

2. **Topic Validation Test:**

   - Enter empty string and click "Generate Practice Problem" - verify error message appears
   - Enter whitespace-only string and click "Generate Practice Problem" - verify error message appears
   - Enter valid topic - verify no error message
   - Select chip and click "Generate Practice Problem" - verify no error message

3. **Problem Generation Test:**

   - Enter topic "fractions" and click "Generate Practice Problem"
   - Verify loading state displays ("Creating a practice problem for you...")
   - Verify generated problem displays in textarea or display area
   - Verify confirmation prompt appears: "Is this the problem you want to practice?"
   - Repeat for "algebra" topic - verify different problem generated
   - Repeat for "geometry" topic - verify different problem generated

4. **Regeneration Test:**

   - Generate problem for "fractions" topic
   - Click "Generate another problem" button
   - Verify loading state displays
   - Verify new problem generated (different from previous)
   - Verify new problem displays correctly

5. **Confirmation Flow Test:**

   - Generate problem and click "Yes, start practicing"
   - Verify MathProblem created with:
     - `source: 'generated'`
     - `rawContent` matches generated problem
     - `parsedContent` matches generated problem
     - `topic` matches input topic
   - Verify navigation to workspace page
   - Verify problem is stored in Zustand store

6. **Error Handling Test:**

   - Simulate API failure - verify error message appears
   - Verify "Try again" button allows retry
   - Verify "Enter manually" option switches to text input
   - Verify error messages are user-friendly (not technical)

7. **Responsive Layout Test:**

   - Test on tablet (768px width) - verify layout works correctly
   - Test on laptop (1280px+ width) - verify layout works correctly
   - Verify suggestion chips wrap appropriately on smaller screens
   - Verify topic input is appropriately sized for all screen sizes

8. **Accessibility Test:**
   - Test keyboard navigation (tab, enter, space)
   - Verify focus states are visible for keyboard users
   - Verify color contrast meets WCAG AA standards (4.5:1 minimum)
   - Verify touch targets are appropriately sized (44px minimum)
   - Verify form label is properly associated with topic input

**Test Validation Checklist:**

- [ ] Topic input displays correctly with placeholder text
- [ ] Suggestion chips display correctly and are clickable
- [ ] Topic validation prevents empty submissions
- [ ] Problem generation works for "fractions" topic
- [ ] Problem generation works for "algebra" topic
- [ ] Problem generation works for custom topics
- [ ] Loading state displays during generation
- [ ] Generated problem displays correctly
- [ ] Confirmation prompt appears
- [ ] "Yes, start practicing" creates MathProblem and navigates
- [ ] "Generate another problem" regenerates problem
- [ ] Error handling works for all scenarios
- [ ] Responsive layout works on tablet and laptop
- [ ] Keyboard navigation works
- [ ] Color contrast meets accessibility standards
- [ ] Touch targets are appropriately sized

---

## Change Log

| Date       | Version | Description                            | Author             |
| ---------- | ------- | -------------------------------------- | ------------------ |
| 2025-01-12 | 1.0     | Story created from Epic 2 requirements | Scrum Master (Bob) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (via Cursor)

### Debug Log References

N/A - No debug issues encountered during implementation

### Completion Notes List

1. **Practice Problem Component**: Created `PracticeProblemInput.tsx` with topic input, suggestion chips, and problem generation flow
2. **Topic Input and Validation**: Implemented topic input with validation (not empty/whitespace) and suggestion chips for common topics
3. **Generate Problem API Route**: Created `/api/generate-problem` route with validation, error handling using standard error handler, and GPT-4 integration
4. **Generate Problem API Service**: Created client-side service following existing API service patterns
5. **Problem Generation in LLM Service**: Added `generatePracticeProblem()` method to LLM service using GPT-4 with proper prompt formatting
6. **Problem Generation Flow**: Implemented complete generation flow with loading states, error handling, and generated problem display
7. **Generated Problem Confirmation**: Implemented approve/regenerate/change topic options with loading states
8. **MathProblem Creation**: Created MathProblem object with `source: 'generated'`, topic, and generated content
9. **Problem Input Page Update**: Updated to detect practice mode from URL search params (`mode=practice`) and show appropriate component
10. **Generation Prompt**: Added `PRACTICE_PROBLEM_GENERATION_PROMPT_V1` to prompts.ts following coding standards
11. **Error Handling**: Comprehensive error handling for all scenarios (empty topic, API failures, generation failures) with recovery options
12. **Loading States**: Implemented loading spinner and "Creating a practice problem for you..." message during generation
13. **Responsive Design**: All components styled with Tailwind CSS following design vision, with proper touch targets (44px minimum) and responsive layout
14. **Suspense Boundary**: Added Suspense boundary for `useSearchParams()` to comply with Next.js 14 requirements

### File List

**New Files:**

- `src/components/problem-input/PracticeProblemInput.tsx` - Practice problem component with topic input, suggestion chips, and generation flow
- `src/app/api/generate-problem/route.ts` - API route for problem generation via GPT-4
- `src/services/api/generateProblemApi.ts` - Client-side API service for generate-problem endpoint

**Modified Files:**

- `src/app/problem-input/page.tsx` - Added practice mode detection from URL search params with Suspense boundary
- `src/services/llmService.ts` - Added `generatePracticeProblem()` method for GPT-4 problem generation
- `src/services/prompts.ts` - Added `PRACTICE_PROBLEM_GENERATION_PROMPT_V1` for practice problem generation
- `src/types/api.ts` - Added `GenerateProblemRequest` and `GenerateProblemResponse` types

---

## QA Results

### Review Date: 2025-01-12

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment:** The implementation is comprehensive, well-structured, and follows Next.js and React best practices. The code properly implements topic selection, suggestion chips, problem generation via GPT-4, error handling, and confirmation flow. All acceptance criteria are met with excellent code quality.

**Strengths:**

- Clean component structure with proper separation of concerns
- Comprehensive topic validation with user-friendly error messages
- Excellent suggestion chips implementation with visual feedback
- Proper error handling at all levels (validation, API errors, generation failures)
- Good loading states and user feedback
- Proper use of Suspense boundary for `useSearchParams()` (Next.js 14 requirement)
- Prompt properly located in `prompts.ts` (coding standards compliance)
- Proper TypeScript typing throughout
- Good accessibility attributes (labels, ARIA roles)
- Responsive design with Tailwind CSS
- Proper use of standard error handler in API route

**Areas for Improvement:**

- No blocking issues identified. Error display logic is correct (errors during generation shown at line 189-193, errors during regeneration shown at line 274-289).

### Refactoring Performed

No refactoring performed during review. Error display logic verified and confirmed correct.

### Compliance Check

- **Coding Standards**: ✓ Compliant

  - TypeScript with explicit types ✓
  - Proper file organization ✓
  - Tailwind CSS utility-first approach ✓
  - Client components properly marked ✓
  - API routes use standard error handler ✓
  - Prompt properly located in `src/services/prompts.ts` ✓
  - Service layer used for API calls ✓
  - Types imported from `src/types/` (no duplication) ✓
  - Suspense boundary used for `useSearchParams()` (Next.js 14 requirement) ✓

- **Project Structure**: ✓ Compliant

  - Component location matches architecture (`src/components/problem-input/PracticeProblemInput.tsx`)
  - API route follows Next.js App Router conventions (`src/app/api/generate-problem/route.ts`)
  - Service layer follows patterns (`src/services/api/generateProblemApi.ts`)
  - File naming follows conventions

- **Testing Strategy**: ✓ Compliant (per PRD)

  - Manual testing approach aligns with MVP testing requirements
  - Test scenarios documented in Testing section
  - No automated tests required per PRD (manual QA sufficient for UI components in MVP)

- **All ACs Met**: ✓ All 9 acceptance criteria fully implemented
  - AC1: Topic selection interface provided ✓
  - AC2: Text input field with prompt ✓
  - AC3: Suggestion chips for common topics ✓
  - AC4: "Generate Practice Problem" button triggers generation ✓
  - AC5: API route calls GPT-4 with proper prompt ✓
  - AC6: Generated problem displayed for confirmation ✓
  - AC7: Student can regenerate problem ✓
  - AC8: Confirmed problem proceeds to workspace ✓
  - AC9: Loading state during generation ✓

### Requirements Traceability

**AC1 → Implementation**: Lines 77-82 in `page.tsx` - Practice mode detection and PracticeProblemInput component

- **Test Coverage**: Manual visual inspection (per Testing section)

**AC2 → Implementation**: Lines 170-194 in `PracticeProblemInput.tsx` - Text input field with label and placeholder

- **Test Coverage**: Manual interaction testing (per Testing section)

**AC3 → Implementation**: Lines 196-219 in `PracticeProblemInput.tsx` - Suggestion chips with click handlers (lines 63-69)

- **Test Coverage**: Manual chip interaction testing (per Testing section)

**AC4 → Implementation**: Lines 304-313 in `PracticeProblemInput.tsx` - "Generate Practice Problem" button (lines 74-98)

- **Test Coverage**: Manual generation flow testing (per Testing section)

**AC5 → Implementation**: `src/app/api/generate-problem/route.ts` - API route with GPT-4 integration (lines 41-103)

- **Test Coverage**: Manual API integration testing (per Testing section)

**AC6 → Implementation**: Lines 224-239 in `PracticeProblemInput.tsx` - Generated problem display with confirmation prompt

- **Test Coverage**: Manual confirmation flow testing (per Testing section)

**AC7 → Implementation**: Lines 326-333 in `PracticeProblemInput.tsx` - "Generate Another Problem" button (lines 103-123)

- **Test Coverage**: Manual regeneration testing (per Testing section)

**AC8 → Implementation**: Lines 334-342 in `PracticeProblemInput.tsx` - "Yes, start practicing" button (lines 128-134)

- **Test Coverage**: Manual confirmation flow testing (per Testing section)

**AC9 → Implementation**: Lines 243-271 in `PracticeProblemInput.tsx` - Loading state ("Creating a practice problem for you...")

- **Test Coverage**: Manual loading state testing (per Testing section)

**Coverage Summary**: All 9 acceptance criteria have corresponding test scenarios documented in the Testing section. Manual testing approach aligns with PRD requirements for MVP.

### Improvements Checklist

- [x] Error display logic verified - errors during generation (before confirmation) are shown at line 189-193, errors during regeneration (in confirmation mode) are shown at line 274-289. Logic is correct.

### Security Review

**Status**: PASS

**Security Considerations:**

- Topic input validation prevents empty/whitespace topics
- API key is server-side only (not exposed to client)
- Input validation in API route prevents invalid requests
- Standard error handler doesn't expose sensitive information
- No file upload or external data handling (lower risk than image upload)

**Recommendations:**

- Consider adding rate limiting for generate-problem API endpoint (future enhancement)
- Consider adding topic validation to prevent injection attacks (future enhancement)

### Performance Considerations

**Status**: PASS

- Topic validation is lightweight (synchronous checks)
- Problem generation is asynchronous with proper loading states
- Suspense boundary prevents blocking during search params resolution
- Bundle size is appropriate (5.5 KB for problem-input route)
- No unnecessary re-renders or state management overhead

**No performance issues identified.**

### Testability Evaluation

**Controllability**: ✓ HIGH

- All inputs are user interactions (topic input, chip clicks, button clicks)
- Topic validation can be tested with various input scenarios
- Problem generation can be tested with various topics
- Navigation can be controlled via router mock in tests
- API calls can be mocked for testing

**Observability**: ✓ HIGH

- Component output is visual (topic input, chips, generated problem, buttons)
- Error messages are displayed clearly
- Loading states are visible
- Navigation can be observed via router state
- Store state can be observed and verified

**Debuggability**: ✓ HIGH

- Component is well-structured and easy to understand
- TypeScript provides compile-time error checking
- Clear error messages for all failure scenarios
- Proper separation of concerns (validation, generation, confirmation)
- API errors are properly handled and logged

### Non-Functional Requirements (NFR) Assessment

**Security**: PASS

- Topic input validation prevents invalid topics
- API key is server-side only
- Input validation in API route
- Standard error handling (no sensitive data exposure)

**Performance**: PASS

- Fast topic validation (synchronous checks)
- Asynchronous problem generation with loading states
- Efficient state management
- Small bundle size (5.5 KB)
- Suspense boundary prevents blocking

**Reliability**: PASS

- Comprehensive error handling for all failure scenarios
- Topic validation prevents invalid topics
- API error handling provides recovery options
- Network error handling allows retry
- Graceful degradation (manual entry option on errors)

**Maintainability**: PASS

- Clean component structure
- Well-documented code with comments
- Follows project conventions
- Easy to understand and modify
- Proper separation of concerns (component, API, service)
- Prompt properly located in prompts.ts file

### Files Modified During Review

No files modified during review. Error display logic verified and confirmed correct.

### Gate Status

**Gate**: PASS → `docs/qa/gates/2.4-topic-based-practice-problem-generation.yml`

**Risk Profile**: Low risk - Problem generation with external API calls, but comprehensive error handling and validation

**NFR Assessment**: All NFRs pass - Component meets security, performance, reliability, and maintainability requirements

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, code quality is excellent. No blocking issues identified.
