# Story 3.1: Student Drawing Tools on Whiteboard

**Status:** Draft

**Epic:** Epic 3: Interactive Whiteboard Collaboration

---

## Story

**As a** student,
**I want** to draw and write directly on the whiteboard using a pen tool,
**so that** I can show my work and try solving the problem visually.

---

## Acceptance Criteria

1. Drawing tool (pen/brush) implemented on the whiteboard canvas
2. Student can draw freehand lines and annotations on the canvas
3. Drawing color: Medium blue (distinct from tutor color, which will be orange)
4. Stroke width: Medium thickness (3-5px), appropriate for finger/mouse drawing
5. Drawing is smooth and responsive (no lag or jitter)
6. Student drawings layer on top of the rendered problem (don't erase the problem)
7. Basic clear/undo functionality available:
   - Clear button removes all student drawings (but keeps problem visible)
   - Optional: Undo button removes last drawing stroke
8. Drawing tool is the default active state (no need to select it from toolbar)
9. Works with both mouse/trackpad and touch input (tablet support)
10. Performance validated: Drawing at 60fps without stuttering

---

## Dev Notes

### Architecture Context

**Canvas Technology Stack:**
[Source: docs/architecture/tech-stack.md]
- **Canvas Library:** Konva.js 9.3+ - HTML5 Canvas abstraction providing simpler API than Fabric.js with better performance; supports touch + mouse input; ~200KB bundle size
- **State Management:** Zustand 4.5+ - Lightweight client state management for canvas state and drawing history
- **Frontend Framework:** Next.js 14.2+ with React 18, TypeScript 5.3+

**Existing Canvas Implementation:**
[Source: docs/stories/2.5-2.7]
- Whiteboard component already exists at `src/components/whiteboard/Whiteboard.tsx`
- Canvas renders mathematical problems using KaTeX
- Current implementation is display-only (no drawing capability yet)

**Component Architecture:**
[Source: docs/architecture/frontend-architecture.md, docs/architecture/components.md]
- Component Organization: `src/components/whiteboard/` contains canvas components
- State Management: Canvas Store (Store 2) manages drawing state and annotations
- Pattern: Container/Presentational separation with Zustand selectors

### Technical Implementation Requirements

**Drawing Implementation:**
1. **Konva.js Line Component** for freehand drawing
   - Use Konva.Line with points array
   - Capture mouse/touch events: mousedown, mousemove, mouseup
   - Add points to line on mousemove when drawing is active
   - Drawing color: #4A90E2 (medium blue)
   - Stroke width: 4px (within 3-5px range for optimal visibility)
   - Line cap: round (smooth line endings)
   - Line join: round (smooth corners)

2. **Touch/Mouse Input Handling:**
   - Implement both mouse events (mousedown, mousemove, mouseup) and touch events (touchstart, touchmove, touchend)
   - Handle event coordinate translation for canvas position
   - Prevent default touch behavior to avoid page scrolling during drawing

3. **Performance Optimization:**
   - Use Konva's built-in layer rendering optimization
   - Implement requestAnimationFrame for smooth 60fps drawing
   - Minimize re-renders by using Konva's internal state management
   - Consider using separate Konva layers: background layer (problem), drawing layer (student work)

**State Management:**
[Source: docs/architecture/components.md - Canvas Store]
1. Zustand Canvas Store should include:
   - `lines: Line[]` - Array of drawing strokes
   - `isDrawing: boolean` - Current drawing state
   - `addLine: (line: Line) => void` - Add new drawing stroke
   - `undoLastLine: () => void` - Remove last stroke
   - `clearAllLines: () => void` - Clear all student drawings
   - `currentTool: 'pen' | 'eraser'` - Current tool (pen as default)

2. Line interface:
   ```typescript
   interface Line {
     id: string;
     points: number[]; // [x1, y1, x2, y2, ...]
     color: string;
     strokeWidth: number;
     timestamp: number;
   }
   ```

**UI Controls:**
1. Add toolbar to workspace with:
   - Clear button (with confirmation modal: "Clear all your drawings?")
   - Undo button (disabled when no lines exist)
   - Visual indication that pen tool is active (default state)

2. Button styling should follow existing Tailwind patterns in the codebase

**Layer Structure:**
1. Bottom layer: Problem rendering (KaTeX content from Epic 2)
2. Top layer: Student drawings (blue strokes)
3. Future layer (not in this story): Tutor annotations (orange)

### File Locations

[Source: docs/architecture/unified-project-structure.md, docs/architecture/frontend-architecture.md]
- **Component:** `src/components/whiteboard/Whiteboard.tsx` (modify existing)
- **Canvas Store:** `src/stores/canvasStore.ts` (create new Zustand store)
- **Types:** `src/types/canvas.ts` (define Line, DrawingTool types)
- **Tests:** `src/components/whiteboard/__tests__/Whiteboard.test.tsx` (selective unit tests per PRD)

### Testing Requirements

[Source: docs/architecture/tech-stack.md]
- **Testing Framework:** Jest 29+ with React Testing Library 14+
- **Testing Strategy:** PRD allows "selective unit tests"; focus on critical canvas functionality
- **Test Cases:**
  1. Line creation on mouse/touch events
  2. State updates (addLine, undoLastLine, clearAllLines)
  3. Drawing mode activation/deactivation
  4. Performance: Verify no memory leaks with many strokes
  5. Visual regression: Drawing doesn't erase problem content

### Technical Constraints

[Source: docs/architecture/tech-stack.md, PRD NFR]
- **Performance Target:** 60fps drawing without stuttering (AC 10)
- **Bundle Size:** Konva.js adds ~200KB; acceptable within budget
- **Browser Compatibility:** Modern browsers with HTML5 Canvas support
- **Accessibility:** Touch and mouse input support (PRD NFR8)
- **Responsive Design:** Must work on tablet/mobile devices with touch input

### Dependencies

**Existing Dependencies (already in project):**
- Konva.js 9.3+ (installed in Epic 2)
- Zustand 4.5+ (installed in Epic 1)
- React 18, TypeScript 5.3+

**No new dependencies required**

### Integration Points

1. **Existing Whiteboard Component:** Extend `src/components/whiteboard/Whiteboard.tsx` to add drawing capability
2. **Problem Rendering:** Ensure drawing layer doesn't interfere with KaTeX-rendered problems (from Story 2.6)
3. **Workspace Layout:** Drawing tools integrate with existing workspace layout (from Story 2.7)
4. **Future Integration:** Canvas state will be serialized for LLM context in Story 3.2 (not implemented yet)

---

## Tasks / Subtasks

- [ ] Create Canvas Store with Zustand (AC: 1, 2)
  - [ ] Create `src/stores/canvasStore.ts`
  - [ ] Define Line interface in `src/types/canvas.ts`
  - [ ] Implement store state: lines, isDrawing, currentTool
  - [ ] Implement store actions: addLine, undoLastLine, clearAllLines, setIsDrawing
  - [ ] Write unit tests for store actions

- [ ] Implement Drawing Capability in Whiteboard Component (AC: 1, 2, 3, 4, 5, 6, 8)
  - [ ] Read existing `src/components/whiteboard/Whiteboard.tsx`
  - [ ] Add Konva.Layer for student drawings (separate from problem layer)
  - [ ] Implement mouse event handlers: handleMouseDown, handleMouseMove, handleMouseUp
  - [ ] Implement touch event handlers: handleTouchStart, handleTouchMove, handleTouchEnd
  - [ ] Create Konva.Line components from canvas store lines state
  - [ ] Set drawing color to #4A90E2 (medium blue)
  - [ ] Set stroke width to 4px
  - [ ] Configure line cap and join to "round" for smooth appearance
  - [ ] Ensure drawing layer renders on top of problem layer
  - [ ] Activate pen tool by default (isDrawing true on canvas interaction)

- [ ] Implement Touch and Mouse Input Support (AC: 9)
  - [ ] Test mouse drawing on desktop browsers
  - [ ] Test touch drawing on mobile/tablet devices
  - [ ] Implement coordinate translation for touch events
  - [ ] Prevent default touch behavior to avoid page scrolling
  - [ ] Verify both input methods work smoothly

- [ ] Add Clear and Undo Controls (AC: 7)
  - [ ] Create DrawingToolbar component in `src/components/whiteboard/DrawingToolbar.tsx`
  - [ ] Add Clear button with confirmation modal
  - [ ] Add Undo button (disabled when lines.length === 0)
  - [ ] Style buttons using Tailwind CSS following existing patterns
  - [ ] Integrate toolbar into Whiteboard component
  - [ ] Connect toolbar actions to canvas store

- [ ] Performance Optimization and Validation (AC: 5, 10)
  - [ ] Implement requestAnimationFrame for smooth rendering
  - [ ] Use separate Konva layers for optimization
  - [ ] Test drawing performance with 50+ strokes
  - [ ] Verify 60fps rendering using browser dev tools
  - [ ] Check for memory leaks with extended drawing sessions
  - [ ] Optimize re-rendering by minimizing React state updates

- [ ] Write Tests for Drawing Functionality (Testing Requirements)
  - [ ] Write unit tests for canvas store in `src/stores/__tests__/canvasStore.test.ts`
  - [ ] Write component tests for Whiteboard drawing in `src/components/whiteboard/__tests__/Whiteboard.test.tsx`
  - [ ] Test line creation on mouse events
  - [ ] Test state updates (addLine, undoLastLine, clearAllLines)
  - [ ] Test drawing mode activation/deactivation
  - [ ] Verify drawing doesn't erase problem content

- [ ] Integration Testing and Validation (AC: All)
  - [ ] Test full workflow: Load problem → Draw on whiteboard → Clear → Undo
  - [ ] Verify drawing persists during conversation (doesn't clear on chat messages)
  - [ ] Test across browsers: Chrome, Firefox, Safari
  - [ ] Test on devices: Desktop (mouse), Tablet (touch), Mobile (touch)
  - [ ] Validate smooth, responsive drawing experience
  - [ ] Verify problem rendering remains intact with drawings on top
  - [ ] Document any issues or edge cases discovered

---

## Agent Model Used

Not yet started

---

## Dev Agent Record

### Debug Log References

None yet

### Completion Notes

None yet

### File List

**Source Files Created:**
- (none yet)

**Source Files Modified:**
- (none yet)

**Source Files Deleted:**
- (none yet)

**Test Files Created:**
- (none yet)

**Test Files Modified:**
- (none yet)

**Other Files Modified:**
- (none yet)

---

## Change Log

| Date | Author | Change Description |
|------|--------|-------------------|
| 2025-01-12 | Orchestrator | Story created from PRD Epic 3.1 with full technical context |

---
