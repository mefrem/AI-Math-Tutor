# Story 2.3: Image Upload with OCR Parsing

**Status:** Ready for Review

**Epic:** Epic 2: Problem Input & Visual Rendering

---

## Story

**As a** student,
**I want** to upload a photo of my homework problem (printed or handwritten),
**so that** I don't have to manually type complex mathematical notation.

---

## Acceptance Criteria

1. Image upload interface provided when student selects "I have a problem" pathway (toggle between text/image input)
2. Drag-and-drop zone accepts image files (PNG, JPG, JPEG formats)
3. File picker button provides alternative to drag-and-drop
4. Uploaded image preview displayed to student before processing
5. "Parse Problem" button triggers OCR via GPT-4 Vision API
6. Next.js API route (`/api/parse-image`) handles GPT-4 Vision integration:
   - Accepts image file (base64 or multipart)
   - Calls OpenAI GPT-4 Vision with prompt: "Extract the mathematical problem from this image as plain text with proper mathematical notation"
   - Returns parsed text
7. Parsed problem text displayed to student with confirmation prompt: "Is this correct?"
8. Student can approve, manually edit parsed text, or re-upload if OCR fails
9. Loading state displayed during OCR processing ("Parsing your problem...")
10. Error handling for unsupported file types, file size limits (5MB max), and API failures

---

## Tasks / Subtasks

- [x] Create image upload component (AC: 1, 2, 3, 4)
  - [x] Create `src/components/problem-input/ImageProblemInput.tsx` component
  - [x] Add drag-and-drop zone for image files
  - [x] Add file picker button as alternative to drag-and-drop
  - [x] Accept PNG, JPG, JPEG formats only
  - [x] Display uploaded image preview before processing
  - [x] Add toggle between text/image input modes (or separate buttons)
  - [x] Style with Tailwind CSS following design vision
  - [x] Add proper accessibility attributes
- [x] Implement file validation (AC: 10)
  - [x] Validate file type (PNG, JPG, JPEG only)
  - [x] Validate file size (5MB maximum)
  - [x] Display error message for unsupported file types
  - [x] Display error message for files exceeding size limit
  - [x] Clear validation errors when valid file is uploaded
- [x] Implement image to base64 conversion (AC: 5, 6)
  - [x] Convert uploaded image file to base64 string
  - [x] Format base64 with data URI prefix (data:image/png;base64,...)
  - [x] Optimize image size if needed (compress large images)
  - [x] Handle image conversion errors gracefully
- [x] Create parse-image API route (AC: 6)
  - [x] Create `src/app/api/parse-image/route.ts` API route
  - [x] Accept POST request with base64 image
  - [x] Validate request body (image required)
  - [x] Call OpenAI GPT-4 Vision API with image
  - [x] Use prompt: "Extract the mathematical problem from this image as plain text with proper mathematical notation"
  - [x] Return parsed text with success status
  - [x] Handle API errors and return appropriate error responses
  - [x] Use standard error handler (`handleApiError`)
- [x] Create parse-image API service (AC: 5, 6)
  - [x] Create `src/services/api/parseImageApi.ts` client-side service
  - [x] Function to call `/api/parse-image` endpoint
  - [x] Accept base64 image string
  - [x] Return parsed text or error
  - [x] Handle network errors and API errors
- [x] Implement OCR parsing flow (AC: 5, 7, 9)
  - [x] Add "Parse Problem" button (enabled when image is uploaded)
  - [x] Call parse-image API when button is clicked
  - [x] Display loading state during OCR processing ("Parsing your problem...")
  - [x] Display parsed text in editable textarea
  - [x] Show confirmation prompt: "Is this correct?"
  - [x] Handle parsing errors gracefully
- [x] Implement parsed text confirmation (AC: 7, 8)
  - [x] Display parsed text in editable textarea
  - [x] Add "Yes, this is correct" button (approves and proceeds)
  - [x] Add "Edit" button (allows manual editing of parsed text)
  - [x] Add "Re-upload" button (allows uploading different image)
  - [x] Handle approval: create MathProblem and navigate to workspace
  - [x] Handle edit: allow manual editing before approval
  - [x] Handle re-upload: reset to image upload state
- [x] Create MathProblem from parsed image (AC: 7, 8)
  - [x] Create MathProblem object with:
    - [x] `problemId`: Generate UUID or timestamp-based ID
    - [x] `source: 'image'`
    - [x] `rawContent`: Original parsed text from OCR
    - [x] `parsedContent`: Same as rawContent (or edited version)
    - [x] `imageUrl`: Base64 image data (optional, for future reference)
  - [x] Store problem in Zustand store
  - [x] Navigate to workspace after approval
- [x] Update problem input page (AC: 1, 2, 3, 4, 5, 7, 8, 9, 10)
  - [x] Update `src/app/problem-input/page.tsx` to support both text and image input
  - [x] Add toggle between text/image input modes (or tabs/buttons)
  - [x] Integrate ImageProblemInput component
  - [x] Handle OCR parsing flow
  - [x] Handle parsed text confirmation
  - [x] Integrate error handling
  - [x] Ensure responsive layout works on tablet and laptop
  - [x] Follow design vision: clean, uncluttered, age-appropriate
- [x] Add GPT-4 Vision support to LLM service (AC: 6)
  - [x] Update `src/services/llmService.ts` to support GPT-4 Vision
  - [x] Add method `parseImage(imageBase64: string): Promise<string>`
  - [x] Use GPT-4 Vision model (`gpt-4-vision-preview` or `gpt-4-turbo` with vision)
  - [x] Format image as base64 in messages array
  - [x] Use OCR prompt for extracting mathematical problems
  - [x] Handle vision API errors
- [x] Error handling (AC: 10)
  - [x] Handle unsupported file types (show error message)
  - [x] Handle file size limits (show error message)
  - [x] Handle API failures (network errors, rate limits, invalid responses)
  - [x] Handle OCR parsing failures (show error, allow re-upload)
  - [x] Display user-friendly error messages (not technical errors)
  - [x] Provide recovery options (re-upload, manual entry)
- [x] Loading states and UX (AC: 9)
  - [x] Show loading spinner during image upload
  - [x] Show loading state during OCR processing ("Parsing your problem...")
  - [x] Disable buttons during processing
  - [x] Show progress indication if possible
  - [x] Smooth transitions between states
- [x] Style and responsive design (AC: 1, 2, 3, 4)
  - [x] Apply consistent color palette (primary blue, secondary green, neutral grays)
  - [x] Style drag-and-drop zone with clear visual feedback
  - [x] Ensure buttons are large enough for touch targets (44px minimum)
  - [x] Add hover and focus states for interactive elements
  - [x] Ensure proper spacing and typography
  - [x] Test responsive layout on tablet (768px) and laptop (1280px+)
  - [x] Ensure image preview displays correctly on all screen sizes

---

## Dev Notes

### Previous Story Insights

**Source:** [Source: Story 2.2 Dev Agent Record]

From Story 2.2 completion:

- Text input component created (`src/components/problem-input/TextProblemInput.tsx`)
- Problem input page updated to use text input component
- MathProblem interface created in `src/types/models.ts`
- Zustand store updated with `currentProblem` state
- Workspace page created as placeholder
- Navigation flow: Landing → Problem Input → Workspace

**Key Context for Story 2.3:**

- Problem input page exists and currently supports text input only
- Need to add image upload option alongside text input
- Toggle between text/image input modes or show both options
- OCR parsing will use GPT-4 Vision API (new integration)
- Parsed text will follow same flow as text input (approval → workspace)
- This story adds the image upload pathway from Epic 2

### Design Vision Requirements

**Source:** [Source: docs/prd.md#user-interface-design-goals]

**Overall UX Vision:**

- Interface should feel like "sitting next to a patient tutor at a shared desk"
- Design prioritizes simplicity, focus, and collaboration over feature-rich complexity
- Experience should be calm and uncluttered—no overwhelming toolbars or competing visual elements
- Color palette: warm and approachable (soft blues, greens, neutrals) rather than stark or corporate
- Typography: large and readable for target age group (8-14 years)

**Problem Input Screen:**

- Image upload area should be prominent and inviting
- Drag-and-drop zone should have clear visual feedback
- Image preview should be clearly visible
- Buttons should be large and clear
- Error messages should be friendly and helpful (not technical)
- Loading states should be clear but not overwhelming

### Component Structure

**Source:** [Source: architecture/frontend-architecture.md#component-organization]

**Component Organization:**

```
src/components/
├── problem-input/         # Problem entry
│   ├── LandingPage.tsx   # Landing page (Story 2.1)
│   ├── TextProblemInput.tsx # Text input (Story 2.2)
│   └── ImageProblemInput.tsx # Image upload (Story 2.3)
```

**Component Pattern:**

- Create presentational component in `src/components/problem-input/`
- Component should be a client component (`'use client'`) since it has file inputs and buttons
- Use TypeScript with explicit props interface
- Follow Container/Presentational separation pattern
- Handle file state locally, call parent callback on submission

### File Locations

**Source:** [Source: architecture/unified-project-structure.md]

**Files to Create:**

- `src/components/problem-input/ImageProblemInput.tsx` - Image upload component
- `src/app/api/parse-image/route.ts` - Parse image API route
- `src/services/api/parseImageApi.ts` - Parse image API service (client-side)

**Files to Modify:**

- `src/app/problem-input/page.tsx` - Add image upload option alongside text input
- `src/services/llmService.ts` - Add GPT-4 Vision support for image parsing
- `src/types/api.ts` - Add ParseImageRequest and ParseImageResponse types (if not exists)

**Routing Structure:**

```
src/app/
├── api/
│   ├── chat/
│   │   └── route.ts       # Chat API (Story 1.3)
│   └── parse-image/
│       └── route.ts       # Parse image API (Story 2.3)
├── problem-input/
│   └── page.tsx          # Problem input page (Story 2.2, 2.3)
└── workspace/
    └── page.tsx          # Tutoring workspace (Story 2.7)
```

### Data Models

**Source:** [Source: architecture/data-models.md#mathproblem]

**MathProblem Interface:**

```typescript
interface MathProblem {
  problemId: string;
  source: "text" | "image" | "generated";
  rawContent: string;
  parsedContent: string;
  topic?: string;
  imageUrl?: string;
  difficulty?: "easy" | "medium" | "hard";
}
```

**For Story 2.3 (Image Upload):**

- `problemId`: Generate UUID or timestamp-based ID
- `source`: Set to `'image'`
- `rawContent`: Parsed text from OCR (original, before editing)
- `parsedContent`: Same as `rawContent` (or edited version if student edits)
- `topic`: Not needed for image upload
- `imageUrl`: Optional - store base64 image data for future reference
- `difficulty`: Not needed for image upload

**Note:** This story does NOT require LaTeX conversion. The OCR extracts plain text with proper mathematical notation. Rendering will be handled in Story 2.6 (KaTeX Mathematical Rendering).

### API Specification

**Source:** [Source: architecture/api-specification.md#parse-image]

**Parse Image API:**

- **Endpoint:** `POST /api/parse-image`
- **Request Body:**
  ```typescript
  {
    image: string; // base64-encoded image (data:image/png;base64,...)
  }
  ```
- **Response:**
  ```typescript
  {
    success: boolean;
    parsedContent: string; // Extracted problem text
    confidence?: number; // 0-1 scale (optional)
  }
  ```
- **Error Response:**
  ```typescript
  {
    error: {
      code: string;
      message: string;
      timestamp: string;
      requestId: string;
    }
  }
  ```

### External APIs

**Source:** [Source: architecture/external-apis.md#openai-api]

**OpenAI GPT-4 Vision API:**

- **Endpoint:** `POST https://api.openai.com/v1/chat/completions`
- **Model:** `gpt-4-vision-preview` or `gpt-4-turbo` (with vision support)
- **Authentication:** Bearer token (API key from `OPENAI_API_KEY`)
- **Image Format:** Base64-encoded image in messages array
- **Prompt:** "Extract the mathematical problem from this image as plain text with proper mathematical notation"
- **Rate Limits:** Tier 1+ recommended (3,500 requests/minute, 10,000 requests/day)
- **Cost:** ~$0.01-0.03 per image (within PRD budget)

### State Management

**Source:** [Source: architecture/frontend-architecture.md#state-management-architecture]

**Zustand Store Pattern:**

- Current store (`useTutoringStore`) has:
  - `sessionId: string | null`
  - `messages: ConversationMessage[]`
  - `isLoading: boolean`
  - `selectedProblem: MathProblem | null` (from Story 1.6)
  - `currentProblem: MathProblem | null` (from Story 2.2)

**For Story 2.3:**

- Reuse `currentProblem` state for image-uploaded problems
- Store problem when "Yes, this is correct" is clicked
- Reset problem when session is reset
- No new store actions needed (reuse `setCurrentProblem` from Story 2.2)

**Component State:**

- Image file state (local component state)
- Base64 image state (local component state)
- Parsed text state (local component state)
- Loading state (local component state)
- Error state (local component state)

### File Upload Requirements

**Source:** [Source: docs/prd.md#acceptance-criteria]

**Supported Formats:**

- PNG (`.png`)
- JPG/JPEG (`.jpg`, `.jpeg`)
- Case-insensitive file extension matching

**File Size Limits:**

- Maximum: 5MB (5,242,880 bytes)
- Reason: API payload limits and processing time
- Error message: "File size must be less than 5MB"

**File Validation:**

- Check file extension (case-insensitive)
- Check file size before upload
- Check MIME type if available
- Display error for unsupported formats

### Image Processing Requirements

**Source:** [Source: docs/prd.md#acceptance-criteria]

**Image to Base64 Conversion:**

- Convert File object to base64 string
- Format as data URI: `data:image/png;base64,...`
- Preserve image quality (no compression needed for MVP)
- Handle conversion errors gracefully

**Image Optimization (Optional):**

- Consider compressing very large images (>2MB)
- Maintain quality for OCR accuracy
- Use browser Image API for resizing if needed

### OCR Parsing Flow

**Source:** [Source: docs/prd.md#acceptance-criteria]

**Parsing Flow:**

1. User uploads image
2. Image preview displayed
3. User clicks "Parse Problem"
4. Loading state shown ("Parsing your problem...")
5. API call to `/api/parse-image` with base64 image
6. GPT-4 Vision extracts problem text
7. Parsed text displayed in editable textarea
8. Confirmation prompt: "Is this correct?"
9. User can approve, edit, or re-upload

**Error Handling:**

- If OCR fails: Show error, allow re-upload or manual entry
- If API fails: Show error, allow retry or manual entry
- If parsing returns empty: Show error, allow re-upload

### GPT-4 Vision Integration

**Source:** [Source: architecture/external-apis.md#openai-api]

**GPT-4 Vision API Call:**

```typescript
const response = await openai.chat.completions.create({
  model: "gpt-4-vision-preview", // or 'gpt-4-turbo' with vision
  messages: [
    {
      role: "user",
      content: [
        {
          type: "text",
          text: "Extract the mathematical problem from this image as plain text with proper mathematical notation.",
        },
        {
          type: "image_url",
          image_url: {
            url: `data:image/png;base64,${base64Image}`,
          },
        },
      ],
    },
  ],
  max_tokens: 500,
});
```

**Prompt Strategy:**

- Use clear, specific prompt for OCR
- Request plain text output (not LaTeX)
- Request proper mathematical notation
- Handle both handwritten and printed problems

### Error Handling

**Source:** [Source: docs/prd.md#acceptance-criteria]

**Error Scenarios:**

1. **Unsupported file type:** Show error "Please upload a PNG, JPG, or JPEG image"
2. **File too large:** Show error "File size must be less than 5MB"
3. **API failure:** Show error "Failed to parse image. Please try again or enter manually."
4. **OCR returns empty:** Show error "Could not extract problem. Please try a clearer image or enter manually."
5. **Network error:** Show error "Connection error. Please check your internet and try again."

**Error Recovery:**

- Provide "Re-upload" button
- Provide "Enter manually" option (switch to text input)
- Allow retry for API failures
- Clear error state when valid file is uploaded

### Loading States

**Source:** [Source: docs/prd.md#acceptance-criteria]

**Loading States:**

1. **Image upload:** Show spinner or progress indicator
2. **OCR processing:** Show "Parsing your problem..." message with spinner
3. **Disable buttons:** Prevent multiple submissions during processing
4. **Smooth transitions:** Use CSS transitions for state changes

### Styling Requirements

**Source:** [Source: architecture/coding-standards.md#styling-with-tailwind]

**Tailwind CSS Patterns:**

- Use utility-first approach with Tailwind classes
- Apply responsive design with mobile-first classes (`md:`, `lg:`)
- Use color palette from design vision:
  - Primary: `bg-blue-500` or custom color `#4A90E2`
  - Secondary: `bg-green-500` or custom color `#7CB342`
  - Neutral: `bg-gray-100`, `text-gray-900`
  - Error: `bg-red-100`, `text-red-700`
- Ensure proper spacing with Tailwind spacing scale
- Use Tailwind typography utilities for readable text

**Drag-and-Drop Zone Styling:**

- Large, clear drop zone with border
- Visual feedback on drag-over (highlight border)
- Icon or text indicating drag-and-drop
- File picker button as alternative
- Hover and focus states

**Image Preview Styling:**

- Display uploaded image with max dimensions
- Preserve aspect ratio
- Clear visual indication of uploaded image
- Remove/clear button for re-upload

### Responsive Design Requirements

**Source:** [Source: docs/prd.md#target-device-and-platforms]

**Target Devices:**

- **Primary:** Laptops (1280px+ width) - MacBook, Chromebook, Windows laptop
- **Secondary:** Tablets in landscape (768px-1024px width) - iPad, Android tablets
- **Out of scope:** Mobile phones (too small for effective interaction)

**Responsive Layout:**

- Use Tailwind responsive classes: `md:` for tablet (768px+), `lg:` for laptop (1024px+)
- Ensure layout works at minimum 768px width
- Test on both tablet and laptop screen sizes
- Image preview should scale appropriately
- Drag-and-drop zone should be full-width on tablet, centered with max-width on laptop

### Accessibility Requirements

**Source:** [Source: docs/prd.md#accessibility]

**Target Level: WCAG AA Compliance (Partial for MVP)**

**Priority Requirements:**

- **Keyboard navigation:** All interactive elements (buttons, file input) accessible via keyboard
- **Color contrast:** Minimum 4.5:1 contrast ratio for text and important UI elements
- **Focus indicators:** Clear visual focus states for keyboard users
- **Touch targets:** Minimum 44px for tablet touch interaction
- **File input labels:** Proper label association with file input

**Out of scope for MVP:**

- Screen reader optimization (aria labels, semantic HTML—address in post-MVP)
- Full WCAG AA compliance audit

### Technical Constraints

**Source:** [Source: architecture/tech-stack.md]

**Technology Stack:**

- **Framework:** Next.js 14+ App Router (TypeScript)
- **Styling:** Tailwind CSS 3.4+
- **State Management:** Zustand 4.5+ (existing store)
- **File Handling:** Browser File API, FileReader API
- **Image Processing:** Browser Image API (optional)
- **API Integration:** OpenAI Node.js SDK
- **Navigation:** Next.js `useRouter` or `Link` component

**TypeScript Requirements:**

- Strict mode enabled
- Explicit prop interfaces for components
- No `any` types without explicit comments
- Proper typing for File objects and base64 strings

### Testing Requirements

**Source:** [Source: docs/prd.md#testing-requirements]

**Testing Standards for this Story:**

- **Test Approach:** Manual validation through visual inspection and interaction testing
- **Test Scenarios:**
  1. Image upload works with drag-and-drop
  2. Image upload works with file picker
  3. File validation prevents unsupported formats
  4. File validation prevents oversized files
  5. OCR parsing extracts problem text correctly
  6. Parsed text confirmation flow works
  7. Error handling works for all error scenarios
  8. Loading states display correctly

**Specific Test Cases:**

- **Test 1:** Drag-and-drop - verify image uploads via drag-and-drop
- **Test 2:** File picker - verify image uploads via file picker button
- **Test 3:** File validation - verify unsupported formats are rejected
- **Test 4:** File size - verify files >5MB are rejected
- **Test 5:** OCR parsing - verify printed problem is parsed correctly
- **Test 6:** OCR parsing - verify handwritten problem is parsed correctly
- **Test 7:** Error handling - verify API failures show user-friendly errors
- **Test 8:** Confirmation flow - verify approve/edit/re-upload options work
- **Test 9:** Responsive - verify layout works on tablet and laptop

**Success Criteria:**

- Image upload works correctly (drag-and-drop and file picker)
- File validation prevents invalid files
- OCR parsing extracts problem text
- Parsed text confirmation flow works
- Error handling provides recovery options
- UI follows design vision

### Project Structure Notes

No conflicts identified between PRD requirements and architecture structure. The PRD specifies image upload with OCR parsing, and the architecture supports file uploads, API routes, and GPT-4 Vision integration.

**Note on Implementation:**

- This story implements the image upload pathway from Epic 2
- OCR parsing uses GPT-4 Vision (new integration)
- Parsed text follows same flow as text input (approval → workspace)
- This story adds image processing capabilities to the problem input workflow

---

## Testing

**Source:** [Source: docs/prd.md#testing-requirements]

**Testing Standards for this Story:**

- **Test File Location:** Manual testing with visual inspection
- **Test Approach:** Manual validation through browser testing and interaction
- **Test Framework:** N/A (manual testing only)

**Specific Testing Requirements:**

1. **Image Upload Test:**

   - Drag and drop PNG image - verify uploads correctly
   - Drag and drop JPG image - verify uploads correctly
   - Click file picker button - verify file picker opens
   - Select PNG/JPG image - verify uploads correctly
   - Verify image preview displays correctly
   - Verify drag-and-drop zone has visual feedback on drag-over

2. **File Validation Test:**

   - Upload unsupported file (e.g., PDF, GIF) - verify error message appears
   - Upload file >5MB - verify error message appears
   - Upload valid file after error - verify error clears
   - Verify error messages are user-friendly

3. **OCR Parsing Test:**

   - Upload printed math problem image - verify OCR extracts text correctly
   - Upload handwritten math problem image - verify OCR extracts text correctly
   - Verify loading state displays during parsing ("Parsing your problem...")
   - Verify parsed text displays in editable textarea
   - Verify confirmation prompt appears: "Is this correct?"

4. **Confirmation Flow Test:**

   - Click "Yes, this is correct" - verify MathProblem created and navigates to workspace
   - Click "Edit" - verify textarea becomes editable
   - Edit parsed text and click "Start Tutoring" - verify edited text is used
   - Click "Re-upload" - verify resets to image upload state

5. **Error Handling Test:**

   - Simulate API failure - verify error message appears
   - Verify "Re-upload" button allows retry
   - Verify "Enter manually" option switches to text input
   - Verify error messages are user-friendly (not technical)

6. **Responsive Layout Test:**

   - Test on tablet (768px width) - verify layout works correctly
   - Test on laptop (1280px+ width) - verify layout works correctly
   - Verify image preview displays correctly on all screen sizes
   - Verify drag-and-drop zone is appropriately sized

7. **Accessibility Test:**
   - Test keyboard navigation (tab, enter, space)
   - Verify focus states are visible for keyboard users
   - Verify color contrast meets WCAG AA standards (4.5:1 minimum)
   - Verify touch targets are appropriately sized (44px minimum)
   - Verify file input is properly labeled

**Test Validation Checklist:**

- [ ] Drag-and-drop uploads image correctly
- [ ] File picker uploads image correctly
- [ ] Image preview displays correctly
- [ ] Unsupported file types are rejected
- [ ] Files >5MB are rejected
- [ ] OCR parsing extracts printed problems correctly
- [ ] OCR parsing extracts handwritten problems correctly
- [ ] Loading state displays during parsing
- [ ] Parsed text displays in textarea
- [ ] Confirmation prompt appears
- [ ] "Yes, this is correct" creates MathProblem and navigates
- [ ] "Edit" allows manual editing
- [ ] "Re-upload" resets to upload state
- [ ] Error handling works for all scenarios
- [ ] Responsive layout works on tablet and laptop
- [ ] Keyboard navigation works
- [ ] Color contrast meets accessibility standards
- [ ] Touch targets are appropriately sized

---

## Change Log

| Date       | Version | Description                            | Author             |
| ---------- | ------- | -------------------------------------- | ------------------ |
| 2025-01-12 | 1.0     | Story created from Epic 2 requirements | Scrum Master (Bob) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (via Cursor)

### Debug Log References

N/A - No debug issues encountered during implementation

### Completion Notes List

1. **Image Upload Component**: Created `ImageProblemInput.tsx` with full drag-and-drop support, file picker, image preview, and toggle between text/image modes
2. **File Validation**: Implemented comprehensive validation for file type (PNG, JPG, JPEG) and file size (5MB max) with user-friendly error messages
3. **Base64 Conversion**: Implemented image-to-base64 conversion using FileReader API with proper data URI formatting
4. **Parse Image API Route**: Created `/api/parse-image` route with validation, error handling using standard error handler, and GPT-4 Vision integration
5. **Parse Image API Service**: Created client-side service following existing API service patterns
6. **GPT-4 Vision Integration**: Added `parseImage()` method to LLM service using `gpt-4-vision-preview` model with proper image formatting
7. **OCR Parsing Flow**: Implemented complete OCR flow with loading states, error handling, and parsed text display
8. **Parsed Text Confirmation**: Implemented editable textarea with approve/edit/re-upload options
9. **Problem Input Page**: Updated to support both text and image input modes with toggle functionality
10. **Error Handling**: Comprehensive error handling for all scenarios (file validation, API errors, parsing failures) with recovery options
11. **Loading States**: Implemented loading spinner and "Parsing your problem..." message during OCR processing
12. **Responsive Design**: All components styled with Tailwind CSS following design vision, with proper touch targets (44px minimum) and responsive layout
13. **Compliance Fix**: Moved OCR prompt from `llmService.ts` to `prompts.ts` per coding standards (addressed QA review feedback)

### File List

**New Files:**

- `src/components/problem-input/ImageProblemInput.tsx` - Image upload component with drag-and-drop, OCR parsing, and confirmation flow
- `src/app/api/parse-image/route.ts` - API route for image parsing via GPT-4 Vision
- `src/services/api/parseImageApi.ts` - Client-side API service for parse-image endpoint

**Modified Files:**

- `src/app/problem-input/page.tsx` - Added toggle between text/image input modes
- `src/components/problem-input/TextProblemInput.tsx` - Added toggle button to switch to image mode
- `src/services/llmService.ts` - Added `parseImage()` method for GPT-4 Vision integration (uses OCR_PARSING_PROMPT_V1 from prompts.ts)
- `src/services/prompts.ts` - Added OCR_PARSING_PROMPT_V1 for image parsing (compliance fix per QA review)
- `src/types/api.ts` - Added `ParseImageRequest` and `ParseImageResponse` types

---

## QA Results

### Review Date: 2025-01-12

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment:** The implementation is comprehensive, well-structured, and follows Next.js and React best practices. The code properly implements image upload, drag-and-drop, file validation, OCR parsing via GPT-4 Vision, and error handling. All acceptance criteria are met with one compliance improvement recommended for prompt organization.

**Strengths:**

- Comprehensive file validation (type and size)
- Excellent drag-and-drop implementation with visual feedback
- Proper error handling at all levels (file validation, API errors, parsing failures)
- Good loading states and user feedback
- Clean separation of concerns (component, API route, service layer)
- Proper TypeScript typing throughout
- Good accessibility attributes (labels, ARIA roles)
- Responsive design with Tailwind CSS
- Proper use of standard error handler in API route

**Areas for Improvement:**

- OCR prompt is inlined in `llmService.ts` instead of being in `prompts.ts` (coding standards violation)
- Consider extracting file validation constants to a shared constants file (optional enhancement)

### Refactoring Performed

No refactoring performed during review. Compliance issue identified was fixed by dev:

- **File**: `src/services/llmService.ts` and `src/services/prompts.ts`
  - **Change**: OCR prompt moved from `llmService.ts` to `prompts.ts` (compliance improvement)
  - **Why**: Coding standards require all OpenAI prompts to live in `src/services/prompts.ts`
  - **How**: Dev added `OCR_PARSING_PROMPT_V1` to `prompts.ts` and updated `llmService.ts` to import it

### Compliance Check

- **Coding Standards**: ✓ Compliant

  - TypeScript with explicit types ✓
  - Proper file organization ✓
  - Tailwind CSS utility-first approach ✓
  - Client components properly marked ✓
  - API routes use standard error handler ✓
  - OCR prompt properly located in `src/services/prompts.ts` ✓ (fixed by dev)
  - Service layer used for API calls ✓
  - Types imported from `src/types/` (no duplication) ✓

- **Project Structure**: ✓ Compliant

  - Component location matches architecture (`src/components/problem-input/ImageProblemInput.tsx`)
  - API route follows Next.js App Router conventions (`src/app/api/parse-image/route.ts`)
  - Service layer follows patterns (`src/services/api/parseImageApi.ts`)
  - File naming follows conventions

- **Testing Strategy**: ✓ Compliant (per PRD)

  - Manual testing approach aligns with MVP testing requirements
  - Test scenarios documented in Testing section
  - No automated tests required per PRD (manual QA sufficient for UI components in MVP)

- **All ACs Met**: ✓ All 10 acceptance criteria fully implemented
  - AC1: Image upload interface with toggle ✓
  - AC2: Drag-and-drop zone accepts PNG, JPG, JPEG ✓
  - AC3: File picker button provided ✓
  - AC4: Image preview displayed ✓
  - AC5: "Parse Problem" button triggers OCR ✓
  - AC6: API route handles GPT-4 Vision integration ✓
  - AC7: Parsed text displayed with confirmation prompt ✓
  - AC8: Student can approve, edit, or re-upload ✓
  - AC9: Loading state during OCR processing ✓
  - AC10: Error handling for all scenarios ✓

### Requirements Traceability

**AC1 → Implementation**: Lines 258-273 in `ImageProblemInput.tsx` - Toggle buttons for text/image modes

- **Test Coverage**: Manual visual inspection (per Testing section)

**AC2 → Implementation**: Lines 276-334 in `ImageProblemInput.tsx` - Drag-and-drop zone with file type validation (lines 29-44)

- **Test Coverage**: Manual drag-and-drop testing (per Testing section)

**AC3 → Implementation**: Lines 320-328 in `ImageProblemInput.tsx` - File picker button (lines 175-177)

- **Test Coverage**: Manual file picker testing (per Testing section)

**AC4 → Implementation**: Lines 337-368 in `ImageProblemInput.tsx` - Image preview display

- **Test Coverage**: Manual visual inspection (per Testing section)

**AC5 → Implementation**: Lines 449-459 in `ImageProblemInput.tsx` - "Parse Problem" button (lines 197-218)

- **Test Coverage**: Manual OCR parsing testing (per Testing section)

**AC6 → Implementation**: `src/app/api/parse-image/route.ts` - API route with GPT-4 Vision integration (lines 41-97)

- **Test Coverage**: Manual API integration testing (per Testing section)

**AC7 → Implementation**: Lines 371-389 in `ImageProblemInput.tsx` - Parsed text display with confirmation prompt

- **Test Coverage**: Manual confirmation flow testing (per Testing section)

**AC8 → Implementation**: Lines 462-482 in `ImageProblemInput.tsx` - Approve/edit/re-upload buttons (lines 223-253)

- **Test Coverage**: Manual confirmation flow testing (per Testing section)

**AC9 → Implementation**: Lines 409-435 in `ImageProblemInput.tsx` - Loading state during parsing ("Parsing your problem...")

- **Test Coverage**: Manual loading state testing (per Testing section)

**AC10 → Implementation**: Lines 29-54 in `ImageProblemInput.tsx` - File validation; Lines 393-406 - Error display; Lines 41-97 in `route.ts` - API error handling

- **Test Coverage**: Manual error handling testing (per Testing section)

**Coverage Summary**: All 10 acceptance criteria have corresponding test scenarios documented in the Testing section. Manual testing approach aligns with PRD requirements for MVP.

### Improvements Checklist

- [x] Move OCR prompt from `llmService.ts` to `src/services/prompts.ts` (coding standards compliance) - **Fixed by dev**
- [ ] Consider extracting file validation constants (ALLOWED_FILE_TYPES, MAX_FILE_SIZE) to shared constants file (optional enhancement)

### Security Review

**Status**: PASS

**Security Considerations:**

- File validation prevents malicious file types (PNG, JPG, JPEG only)
- File size limit (5MB) prevents DoS attacks via large file uploads
- Base64 encoding is handled properly (client-side conversion)
- API key is server-side only (not exposed to client)
- Input validation in API route prevents invalid requests
- Standard error handler doesn't expose sensitive information

**Recommendations:**

- Consider adding rate limiting for parse-image API endpoint (future enhancement)
- Consider adding file content validation (not just extension) for additional security (future enhancement)

### Performance Considerations

**Status**: PASS

- File validation is lightweight (synchronous checks)
- Base64 conversion is handled asynchronously (doesn't block UI)
- Image preview uses data URI (no additional network requests)
- OCR API calls are asynchronous with proper loading states
- Bundle size is appropriate (4.68 KB for problem-input route)
- No unnecessary re-renders or state management overhead

**No performance issues identified.**

### Testability Evaluation

**Controllability**: ✓ HIGH

- All inputs are user interactions (file upload, button clicks)
- File validation can be tested with various file types/sizes
- OCR parsing can be tested with various images
- Navigation can be controlled via router mock in tests
- API calls can be mocked for testing

**Observability**: ✓ HIGH

- Component output is visual (upload zone, preview, parsed text)
- Error messages are displayed clearly
- Loading states are visible
- Navigation can be observed via router state
- Store state can be observed and verified

**Debuggability**: ✓ HIGH

- Component is well-structured and easy to understand
- TypeScript provides compile-time error checking
- Clear error messages for all failure scenarios
- Proper separation of concerns (validation, parsing, confirmation)
- API errors are properly handled and logged

### Non-Functional Requirements (NFR) Assessment

**Security**: PASS

- File type validation prevents malicious files
- File size limits prevent DoS attacks
- API key is server-side only
- Input validation in API route
- Standard error handling (no sensitive data exposure)

**Performance**: PASS

- Fast file validation (synchronous checks)
- Asynchronous base64 conversion (doesn't block UI)
- Asynchronous OCR parsing with loading states
- Efficient state management
- Small bundle size (4.68 KB)

**Reliability**: PASS

- Comprehensive error handling for all failure scenarios
- File validation prevents invalid files
- API error handling provides recovery options
- Network error handling allows retry
- Graceful degradation (manual entry option on errors)

**Maintainability**: PASS

- Clean component structure
- Well-documented code with comments
- Follows project conventions
- Easy to understand and modify
- Proper separation of concerns (component, API, service)

### Files Modified During Review

No files modified during review. Compliance issue identified was fixed by dev:

- `src/services/prompts.ts` - Added `OCR_PARSING_PROMPT_V1` constant
- `src/services/llmService.ts` - Updated to import `OCR_PARSING_PROMPT_V1` from `prompts.ts`

**Note**: Dev successfully fixed the compliance issue by moving the OCR prompt to the prompts file as recommended.

### Gate Status

**Gate**: PASS → `docs/qa/gates/2.3-image-upload-with-ocr-parsing.yml`

**Risk Profile**: Low-Medium risk - Image upload with external API calls, but comprehensive error handling and validation

**NFR Assessment**: All NFRs pass - Component meets security, performance, reliability, and maintainability requirements

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, code quality is excellent, compliance issue fixed by dev. No blocking issues identified.
